===== FILE: C:\laragon\www\saas-core-engine\apps\web\src\features\auth\forgot-password\index.ts =====
export { ForgotPasswordForm } from "./ui/ForgotPasswordForm";
export { forgotPasswordAction } from "./api/forgot-password.action";
export type { ForgotPasswordFormState } from "./api/forgot-password.action";
export { forgotPasswordFormSchema } from "./model/forgot-password.schema";
export type { ForgotPasswordValues } from "./model/forgot-password.schema";


===== FILE: C:\laragon\www\saas-core-engine\apps\web\src\features\auth\forgot-password\api\forgot-password.action.ts =====
"use server";

import { createPasswordResetFlow } from "@/server/adapters/core/auth-core.adapter";
import { authErrorMessage } from "@/server/auth/auth-error-message";
import { enforceAuthRateLimit } from "@/server/auth/auth-rate-limit";
import { getEmailService } from "@/server/services/email.service";
import { absoluteUrl } from "@/server/services/url.service";

import { buildActionRequest } from "../../api/server-action-request.api";
import { forgotPasswordFormSchema } from "../model/forgot-password.schema";

const FORGOT_PASSWORD_ACTION_PATH = "/forgot-password";
const FORGOT_PASSWORD_RATE_LIMIT_KEY = "password_forgot" as const;
const PASSWORD_RESET_TTL_MINUTES = 15;
const INVALID_INPUT_MESSAGE = "Invalid input";
const SEND_RESET_FAILED_MESSAGE = "Failed to send reset link.";
const FORGOT_PASSWORD_SUCCESS_MESSAGE = "If the email exists, a reset link was sent.";

export type ForgotPasswordFormState = {
  error: string | null;
  success: string | null;
};

export const forgotPasswordInitialState: ForgotPasswordFormState = {
  error: null,
  success: null,
};

export async function forgotPasswordAction(
  _prevState: ForgotPasswordFormState,
  formData: FormData,
): Promise<ForgotPasswordFormState> {
  const validated = forgotPasswordFormSchema.safeParse({
    email: String(formData.get("email") ?? ""),
  });

  if (!validated.success) {
    return {
      error: validated.error.errors[0]?.message ?? INVALID_INPUT_MESSAGE,
      success: null,
    };
  }

  const start = Date.now();

  try {
    const req = await buildActionRequest(FORGOT_PASSWORD_ACTION_PATH);
    await enforceAuthRateLimit(req, FORGOT_PASSWORD_RATE_LIMIT_KEY);

    const flow = createPasswordResetFlow();
    const result = await flow.request({
      email: validated.data.email,
      ttlMinutes: PASSWORD_RESET_TTL_MINUTES,
    });

    if ("token" in result && typeof result.token === "string" && result.token.length > 0) {
      const token = result.token;

      const url = absoluteUrl(`/reset-password?token=${encodeURIComponent(token)}`);

      await getEmailService().sendResetPassword(validated.data.email, url);
    }
  } catch {
    // intentionally swallow to prevent user enumeration
  }

  // mitigate timing attacks
  const elapsed = Date.now() - start;
  if (elapsed < 400) {
    await new Promise((r) => setTimeout(r, 400 - elapsed));
  }

  return {
    error: null,
    success: FORGOT_PASSWORD_SUCCESS_MESSAGE,
  };
}


===== FILE: C:\laragon\www\saas-core-engine\apps\web\src\features\auth\forgot-password\model\forgot-password.schema.ts =====
import * as z from "zod";

export const forgotPasswordFormSchema = z.object({
  email: z
    .string()
    .trim()
    .email("Email format is invalid")
    .max(320, "Email must be at most 320 characters."),
});

export type ForgotPasswordValues = z.infer<typeof forgotPasswordFormSchema>;


===== FILE: C:\laragon\www\saas-core-engine\apps\web\src\features\auth\forgot-password\ui\ForgotPasswordForm.tsx =====
"use client";

import { useActionState } from "react";

import {
  forgotPasswordAction,
  forgotPasswordInitialState,
} from "@/features/auth/forgot-password/api/forgot-password.action";
import { Button } from "@/shared/components/ui/button";
import { Field, FieldGroup, FieldLabel } from "@/shared/components/ui/field";
import { Input } from "@/shared/components/ui/input";

export function ForgotPasswordForm() {
  const [state, formAction, pending] = useActionState(
    forgotPasswordAction,
    forgotPasswordInitialState,
  );

  return (
    <form action={formAction} className="grid gap-3">
      <FieldGroup>
        <Field>
          <FieldLabel htmlFor="forgot-password-email">Email</FieldLabel>
          <Input
            id="forgot-password-email"
            name="email"
            type="email"
            placeholder="you@company.com"
            autoComplete="email"
            required
          />
        </Field>
      </FieldGroup>

      {state.error ? <p className="text-sm text-red-600">{state.error}</p> : null}
      {state.success ? <p className="text-sm text-emerald-600">{state.success}</p> : null}

      <Button className="rounded-xl" disabled={pending}>
        {pending ? "Sending..." : "Send reset link"}
      </Button>
    </form>
  );
}


